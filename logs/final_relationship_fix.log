ğŸš€ COMPLETE VVB-VERRA RELATIONSHIP FIX

This script will fix ALL relationship issues for VVB Management page:
1. Foreign key constraints for proper Supabase relationships
2. Direct link between vvb_engagements and verra_project_registrations
3. Data linking for existing records
============================================================
============================================================
ğŸ”§ COMPLETE RELATIONSHIP FIX
============================================================
âœ… Connected to db.saelrsljpneclsbfdxfy.supabase.co

ğŸ“‹ STEP 1: Ensure verra_project_registrations.carbon_project_id references carbon_projects.id
âœ… Added foreign key: carbon_project_id â†’ carbon_projects.id

ğŸ“‹ STEP 2: Ensure vvb_engagements.project_id references carbon_projects.id
âœ… Foreign key already exists

ğŸ“‹ STEP 3: Ensure verra_registration_id relationship exists
âœ… verra_registration_id column already exists
âœ… Foreign key already exists

ğŸ“‹ STEP 4: Update data to link through verra_registration_id

ğŸ“‹ STEP 5: Verify all relationships

ğŸ”— Current foreign keys:
   â€¢ verra_project_registrations.carbon_project_id â†’ carbon_projects.id
   â€¢ verra_project_registrations.project_id â†’ carbon_projects.id
   â€¢ vvb_engagements.project_id â†’ carbon_projects.id
   â€¢ vvb_engagements.verra_registration_id â†’ verra_project_registrations.id
   â€¢ vvb_engagements.vvb_id â†’ vvb_organizations.id

ğŸ“‹ STEP 6: Test frontend query
âœ… Complex query works: 2 results

âœ… All relationship fixes applied!
ğŸ”Œ Database connection closed

============================================================
ğŸ”„ REFRESHING SUPABASE SCHEMA CACHE
============================================================

ğŸ“‹ Supabase needs to refresh its schema cache for new relationships.

ğŸ”§ Options to refresh schema cache:
1. Wait 1-2 minutes (Supabase auto-refreshes periodically)
2. Make a dummy API call to trigger cache refresh
3. Restart Next.js dev server
4. Clear Supabase local cache in browser

ğŸš€ Quick fix: Run this curl command to trigger refresh:

    curl -X POST https://saelrsljpneclsbfdxfy.supabase.co/rest/v1/       -H "apikey: YOUR_ANON_KEY"       -H "Content-Type: application/json"       -d '{"query": "SELECT 1"}'
    

ğŸ“‹ Or restart the Next.js server:

    # Kill current server
    pkill -f "next dev"
    
    # Start fresh
    npm run dev
    

============================================================
ğŸ‰ COMPLETE FIX APPLIED!
============================================================

âœ… All database relationships are now properly configured.

ğŸ“‹ NEXT STEPS:
1. Wait 1-2 minutes for Supabase schema cache refresh
2. Or restart Next.js dev server
3. Clear browser cache
4. Test http://localhost:3001/dashboard/vvb-management

âš ï¸  If still having issues, the frontend code might need adjustment.
   The current query expects a direct relationship between tables.
